  <!-- Inside your <script> tag -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCQcwvZ1dDIWqn5T7aU7KIGlg9GMslvDmI",
      authDomain: "bott-60537.firebaseapp.com",
      projectId: "bott-60537",
      storageBucket: "bott-60537.appspot.com",
      messagingSenderId: "155707196801",
      appId: "1:155707196801:web:1b2c1d287b77bc9662d480",
      measurementId: "G-B0SQBQLD0E"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let lastMatchedIntent = null;
    let currentUser = null;

    auth.onAuthStateChanged(user => {
      console.log("Auth state changed:", user);
      if (user) {
        currentUser = user;
        document.getElementById("google-signin").style.display = "none";
        document.getElementById("anonymous-signin").style.display = "none";
        document.getElementById("auth-bar").style.display = "flex";
        document.getElementById("chatContainer").style.display = "flex";

        const username = user.isAnonymous ? "Anonymous User" : (user.displayName || user.email);
        document.getElementById("username").textContent = "Logged in as: " + username;
        document.getElementById("user-pfp").src = user.photoURL || "https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png";
      } else {
        currentUser = null;
        document.getElementById("google-signin").style.display = "inline-block";
        document.getElementById("anonymous-signin").style.display = "inline-block";
        document.getElementById("auth-bar").style.display = "none";
        document.getElementById("chatContainer").style.display = "none";
      }
    });

    document.getElementById("google-signin").addEventListener("click", () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(error => {
        console.error("Google sign-in error:", error.message);
      });
    });

    document.getElementById("anonymous-signin").addEventListener("click", () => {
      auth.signInAnonymously().catch(error => {
        console.error("Anonymous sign-in error:", error.message);
      });
    });

    function logout() {
      console.log("Logging out user:", currentUser?.uid);
      auth.signOut();
    }

    function addMessage(message, sender, isHTML = false) {
      const chatBox = document.getElementById("chat-box");
      const messageElement = document.createElement("div");
      messageElement.classList.add("message", sender === "user" ? "message-user" : "message-bot");
      messageElement.innerHTML = isHTML ? message : message.replace(/\n/g, "<br>");
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    const fuseOptions = {
      includeScore: true,
      threshold: 0.1, // The threshold value (lower = more strict, higher = more lenient)
      keys: ["keywords", "prompts"], // Search in the keywords and prompts
    };

    async function sendMessage() {
      const input = document.getElementById("userInput").value.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?"']/g, "");
      const text = input.toLowerCase();
      if (!text) return;
    
      addMessage(text, "user");
      document.getElementById("userInput").value = "";
    
      console.log("User input:", text);
    
      // Fetch intents and mapdata collections
      const [intentSnap, mapSnap] = await Promise.all([
        db.collection("intents").get(),
        db.collection("mapdata").get()
      ]);
    
      const intents = intentSnap.docs.map(doc => doc.data());
      const maps = mapSnap.docs.map(doc => doc.data());
    
      console.log("Fetched intents:", intents.length);
      console.log("Fetched mapdata entries:", maps.length); // This will show if mapdata is being fetched properly.
    
      // Check if mapdata collection is empty
      if (maps.length === 0) {
        console.log("No mapdata found.");
      }
    
      // Proceed with map checking logic if mapdata exists
      const mapTriggers = ["location of", "where is", "near me", "nearby", "nearest"];
      const mapTriggerUsed = mapTriggers.find(trigger => text.includes(trigger));
    
      if (mapTriggerUsed) {
        console.log("Checking mapdata first...");
        const mapResults = [];
    
        for (const data of maps) {
        console.log(data);  // Log the entire mapdata entry
        if (!data.prompts || !data.answers || !data.search) {
          console.log("Missing necessary map data:", data);
          continue;  // Skip this entry if it's incomplete
        }
      
        const prompts = data.prompts.map(p => p.toLowerCase());
        const match = prompts.find(p => text.includes(p));
        if (match && data.search) {
          console.log("Matched map prompt:", match);
      
          const iframeHTML = 
            `<iframe
              width="100%"
              height="400"
              style="border:0; margin-top: 10px;"
              loading="lazy"
              allowfullscreen
              referrerpolicy="no-referrer-when-downgrade"
              src="https://www.google.com/maps/embed/v1/place?key=${firebaseConfig.apiKey}&q=${encodeURIComponent(data.search)}">
            </iframe>`;
      
          mapResults.push({
            answer: data.answers[Math.floor(Math.random() * data.answers.length)],
            iframe: iframeHTML
          });
        }
      }
      
      if (mapResults.length > 0) {
        for (const res of mapResults) {
          await addMessage(res.answer + "<br>" + res.iframe, "bot");
        }
        return;  // Exit after map response
      } else {
        console.log("No map matches found.");
      }
    
      // Check intents if no mapdata matched
      const fuse = new Fuse(intents, fuseOptions);
      const result = fuse.search(text);
    
      const matchedIntents = result.map(item => item.item);
    
      if (matchedIntents.length > 0) {
        for (const intent of matchedIntents) {
          const response = intent.answers[Math.floor(Math.random() * intent.answers.length)];
          console.log("Responding with intent answer:", response);
          await addMessage(response, "bot");
          lastMatchedIntent = intent;
        }
        return;
      }
    
    // Default response if no match
      console.log("No map/intent/context matched. Using fallback.");
      await addMessage("I don't have a response for that yet.", "bot");
    } // <-- This is the missing closing bracket!
    console.log("Done!");
  </script>
</body>
</html>
